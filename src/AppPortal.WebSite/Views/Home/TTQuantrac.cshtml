
@{
    ViewData["Title"] = "Chất lượng môi trường";
}

<link href="~/css/chatluong.css" rel="stylesheet" />
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<div class="row">
    <div class="col-md-12">
        <!-- Nav tabs --><div class="card">
            <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active"><a href="#home" aria-controls="home" role="tab" data-toggle="tab">Chất lượng khí</a></li>
                <li role="presentation"><a href="#wqi" aria-controls="profile" role="tab" data-toggle="tab">Chất lượng nước</a></li>
            </ul>
            <!-- Tab panes -->
            <div class="tab-content">
                <div role="tabpanel" class="tab-pane active" id="home">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="form-group">
                                <label for="exampleFormControlSelect2">Trạm</label>
                                <select class="form-control" id="listTram"></select>

                                <div id="chart_div"></div>

                                <table id="aqitable" style="text-align:left;padding:0px;padding-top:3px;padding-bottom:8px;margin:0px;border-spacing:0px;border:0px solid black;width:100%;;">
                                    <tbody></tbody>
                                </table>
                                
                                <div id="thangchiso" style="margin-top: 10px"></div>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <iframe src="https://www.google.com/maps/d/embed?mid=1FdNr6bLh9TprldYQspGmrtk00UM" width="640" height="800"></iframe>
                        </div>
                    </div>
                   
                    <div class="row">
                        <div id="aqi_full" class="col-md-12"></div>
                    </div>
                </div>
                
                <div role="tabpanel" class="tab-pane" id="wqi">
                    
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    google.charts.load('current', { packages: ['corechart', 'bar'] });
    google.charts.setOnLoadCallback(drawAxisTickColors);
    google.charts.setOnLoadCallback(drawWQI);
    function drawAxisTickColors() {
        $.ajax({
            method: "GET",
            url: "http://202.60.104.121/eos/services/call/json/get_stations?qi_type=aqi",
            success: function (data, status) {
                if (data.success == true) {
                    var dulieu = data.stations;
                    $("#listTram").html("");
                    var idFirst = 0;
                    var lstId = [['Trạm', 'Giá trị AQI', { role: 'annotation' }]];
                    for (var i = 0; i < dulieu.length; i++) {
                        if (dulieu[i].qi > 0) {
                            if (idFirst == 0) {
                                idFirst = dulieu[i].id;
                            }
                            lstId.push([dulieu[i].station_name, Math.round(dulieu[i].qi), Math.round(dulieu[i].qi)]);
                            $("#listTram").append("<option value='" + dulieu[i].id + "'>" + dulieu[i].station_name + "</option>");
                        }
                    }
                    vechart(idFirst);
                    vechart2(lstId);
                    vechart3();
                } else {
                    alert("Lỗi API. Xin vui lòng kiểm tra lại!");
                }
            },
            error: function () {
                alert("Lỗi API. Xin vui lòng kiểm tra lại!");
            }
        });
    }

    function vechart3() {
        $.ajax({
            method: "GET",
            url: "http://202.60.104.121/eos/services/call/json/get_common_settings",
            success: function (data, status) {
                if (data.success == true) {
                    var qi_colors = data.qi_colors;
                    
                    var html = '';
                    $("#thangchiso").html("");
                    for (var i = 0; i < qi_colors.length; i++) {
                        html += '<div style="padding:5px;display: inline-block;margin: 3px;background-color: ' + qi_colors[i].color + '">' + qi_colors[i].name + '</div >';
                    }

                    $("#thangchiso").html(html);
                } else {
                    alert("Lỗi API. Xin vui lòng kiểm tra lại!");
                }
            },
            error: function () {
                alert("Lỗi API. Xin vui lòng kiểm tra lại!");
            }
        });
    }

    function vechart(id) {
        $.ajax({
            method: "GET",
            url: "http://202.60.104.121/eos/services/call/json/qi_detail?station_id=" + id,
            success: function (data, status) {
                if (data.success == true) {
                    var dataColumn = [
                        ['Khí', 'Giá trị min', { role: 'annotation' }, 'Giá trị max', { role: 'annotation' }],
                        ['CO', data.res.CO.min, data.res.CO.min, data.res.CO.max, data.res.CO.max],
                        ['NOx', data.res.NOx.min, data.res.NOx.min, data.res.NOx.max, data.res.NOx.max],
                        ['O3', data.res.O3.min, data.res.O3.min, data.res.O3.max, data.res.O3.max],
                        ['SO2', data.res.SO2.min, data.res.SO2.min, data.res.SO2.max, data.res.SO2.max],
                    ];

                    var dataGoogle = google.visualization.arrayToDataTable(dataColumn);
                    var options = {
                        title: data.station_name,
                        height: 350,
                        bar: { groupWidth: '55%' },
                        legend: {
                            position: 'top',
                            alignment: 'start'
                        },
                        annotations: {
                            textStyle: {
                                fontSize: 15,
                            },
                            alwaysOutside: true
                        }
                    };

                    var chart = new google.visualization.BarChart(document.getElementById('chart_div'));
                    chart.draw(dataGoogle, options);

                    //

                    var html = '   <tr>  ' +
                        '  <td class="aqiwgt-table-aqicell" style="padding-right:5px;"><div class="aqivalue" id="aqiwgtvalue" style="font-size: 80px; background-color: ' + data.qi_detail_info.bgColor + '; color: ' + data.qi_detail_info.color + '; text-shadow: rgb(255, 255, 255) 1px 0px 1px;" title="Unhealthy for Sensitive Groups">' + data.qi_value + '</div></td>  ' +
                        ' <td style="width:50%;vertical-align: middle" nowrap="true" class="aqiwgt-table-aqiinfo">  ' +
                        '  <div id="aqiwgtinfo" style="text-shadow: rgb(0, 0, 0) 1px 0px 1px; color: rgb(255, 153, 51);"><span style="font-size:16px;white-space: pre-wrap;line-height: 25px;">' + data.qi_detail_info.description +'</span></div><div style="font-size:16px;font-weight:light;;">  ' +
                        ' </div><div style="font-size:12px;"></div><div style="font-size: 12px; padding-top: 5px; display: block;" id="aqiwgtxtrainfo">Thời gian: <span>' + data.qi_time_2 + '</span></div>  ' +
                        '   </td>  ' +
                        '   </tr>  ';

                    $("#aqitable tbody").html(html);
                } else {
                    alert("Lỗi API. Xin vui lòng kiểm tra lại!");
                }
            },
            error: function () {
                alert("Lỗi API. Xin vui lòng kiểm tra lại!");
            }
        });
    }

    function vechart2(lstId) {
        var dataGoogle = google.visualization.arrayToDataTable(lstId);
        var options = {
            title: 'Biểu đồ giá trị AQI của các trạm',
            height: 450,
            bar: { groupWidth: '65%' },
            legend: {
                alignment: 'center',
                position: 'top'
            },
            annotations: {
                textStyle: {
                    fontSize: 15,
                },
                alwaysOutside: true
            }
        };

        var chart = new google.visualization.ColumnChart(document.getElementById('aqi_full'));
        chart.draw(dataGoogle, options);
    }

    function drawWQI() {
        $.ajax({
            method: "GET",
            url: "http://202.60.104.121/eos/services/call/json/get_stations?qi_type=wqi",
            success: function (data, status) {
                if (data.success == true) {
                    var dulieu = data.stations;
                    $("#listTramWQI").html("");
                    var idFirst = 0;
                    var lstId = [['Trạm', 'Giá trị AQI', { role: 'annotation' }]];
                    for (var i = 0; i < dulieu.length; i++) {
                        if (dulieu[i].qi > 0) {
                            if (idFirst == 0) {
                                idFirst = dulieu[i].id;
                            }
                            lstId.push([dulieu[i].station_name, Math.round(dulieu[i].qi), Math.round(dulieu[i].qi)]);
                            $("#listTramWQI").append("<option value='" + dulieu[i].id + "'>" + dulieu[i].station_name + "</option>");
                        }
                    }
                    
                } else {
                    alert("Lỗi API. Xin vui lòng kiểm tra lại!");
                }
            },
            error: function () {
                alert("Lỗi API. Xin vui lòng kiểm tra lại!");
            }
        });
    }

    $(document).ready(function () {
        $("#listTram").change(function () {
            vechart($(this).val());
        })
    })
</script>